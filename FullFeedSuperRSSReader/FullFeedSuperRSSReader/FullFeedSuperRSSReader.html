<!DOCTYPE html>
<html>
<head>
    <title>Full Feed Super RSS Reader</title>
    <link href="feed.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="sidebar">
        <div id="import">
            <div id="nav">
                <ul>
                   <li><a class="nav" href="about.html">&Agrave; propos</a></li>
                   <li><a class="nav" href="help.html">Aide</a></li>
                   <li><input id="urlNouvAbon" type="text" placeholder="URL du nouveau flux RSS" />
                       <input id="btnAjouter" type="button" value="Ajouter un abonnement" onclick="ajouterAbonnement()">
                   </li>
                </ul>
            </div><hr>
            Importez votre fichier d'abonnements
            <input id="fileinput" type="file" onchange="readSingleFile" /><br>
            <a class="nav" href="">Afficher tous les articles</a>
        </div>
        <div id="output">
        </div>
    </div>
    
    <div id="mainContent">
    </div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<script type="text/javascript">
    //ajoute un abonnement dans le storage local et affiche ses articles
    function ajouterAbonnement(){
        //afficher le nouvel abonnement
        $(".feedTitle").removeClass("feedSelected");
        newURL = "http://montreal.dyndns-ip.com:8888/full-text/makefulltextfeed.php?url="+$("#urlNouvAbon").val();
        loadOneFeedContent(newURL);
        
        //ajouter l'abonnement au fichier
        if(xmlDoc){
            newOutline = xmlDoc.createElement("outline");
            newOutline.setAttribute("xmlUrl", $("#urlNouvAbon").val());
            newOutline.setAttribute("type", "rss");
            var newTitle="";
            while(newTitle==""){
            newTitle = $("#mainContent .rssTitle:first").text();}
          /*  path="//*[@id='content']/div[1]/h3/a[2]";
            // code for IE
            if (window.ActiveXObject){
                var nodes=document.selectNodes(path);
                newTitle = nodes[0].childNodes[0].nodeValue;
            }
            // code for Mozilla, Firefox, Opera, etc.
            else if (document.implementation && document.implementation.createDocument){
                var nodes=document.evaluate(path, xmlDoc, null, XPathResult.ANY_TYPE, null);
                var result=nodes.iterateNext();
                newTitle = result.childNodes[0].nodeValue;
            }*/

            alert(newTitle);
            newOutline.setAttribute("title", newTitle);
            xmlDoc.getElementsByTagName("body")[0].appendChild(newOutline);
            console.log(xmlToString(xmlDoc));
            loadOPMLDoc(xmlDoc);
        }
        
        //ou créer un fichier avec le nouvel abonnement
    }

    //load les pages de navigation dans la section de contenu
    $('.nav').click(function(e) {
            $(".feedTitle").removeClass("feedSelected");
            $("#mainContent").load($(this).attr('href'));
            e.preventDefault();
    });

    //check for cookie
    var path = getCookie("path");
    if (path != null && path != "") {
        //alert("Welcome again " + path);
    }

    if (localStorage.getItem("abonnements")) {
        xmlDoc = $.parseXML(localStorage.getItem("abonnements"));
		loadOPMLDoc(xmlDoc);
    }

    function readSingleFile(evt) {
        //Retrieve the first (and only!) File from the FileList object
        var f = evt.target.files[0];

        if (f) {
            var r = new FileReader();
            r.onload = function (e) {
                var contents = e.target.result;

                //load le dom du fichier d'abonnements
                xmlDoc = $.parseXML(contents);
                localStorage.setItem("abonnements", new XMLSerializer().serializeToString(xmlDoc));
                loadOPMLDoc(xmlDoc);
            }
            r.readAsText(f);
        }
        else {
            alert("Failed to load file");
        }

    }
    document.getElementById('fileinput').addEventListener('change', readSingleFile, false);


    //retourne une string à partir dUn dom xml
    function xmlToString(xmlData) {

        var xmlString;
        //IE
        if (window.ActiveXObject) {
            xmlString = xmlData.xml;
        }
        // code for Mozilla, Firefox, Opera, etc.
        else {
            xmlString = (new XMLSerializer()).serializeToString(xmlData);
        }
        return xmlString;
    } 
        
    //retourne le dom d'une chaine xml
    function loadXMLString(txt) {
        if (window.DOMParser) {
            parser = new DOMParser();
            xmlDoc = parser.parseFromString(txt, "text/xml");
        }
        else // Internet Explorer
        {
            xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
            xmlDoc.async = false;
            xmlDoc.loadXML(txt);
        }
        return xmlDoc
    }

    //retourne le dom d'un fichier xml
    function loadXMLFile(file) {
        if (window.ActiveXObject) {
            xhttp = new ActiveXObject("Msxml2.XMLHTTP.3.0");
        }
        else {
            xhttp = new XMLHttpRequest();
        }
        xhttp.open("GET", file, false);
        xhttp.send("");
        return xhttp.responseXML;
    }

    //retourne le résultat de la transformation xsl
    function transform(xml, xsl) {
        if (window.ActiveXObject) {
            ex = xml.transformNode(xsl);
            return loadXMLString(ex);
        }
        // code for Mozilla, Firefox, Opera, etc.
        else if (document.implementation && document.implementation.createDocument) {
            xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xsl);
            resultDocument = xsltProcessor.transformToFragment(xml, document);
            return resultDocument;
        }
    }

    function loadOPMLDoc(xmlDoc) {
        //load le xslt
        xsl = loadXMLFile("abonnement.xsl");

        //transforme le fichier d'abonnements avec le xslt
        result = transform(xmlDoc, xsl);
        
        output = document.getElementById("output");
        output.innerHTML = "";
        output.appendChild(result);
        
        $('.feedTitle').click(function(e) {
            $(".feedTitle").removeClass("feedSelected");
            $(this).addClass("feedSelected");
            loadOneFeedContent($(this).attr('href'));
            e.preventDefault();
        });

        supp = "<a class='supp'> x</a>";
        $('.feedTitle').hover(
          function () {
            $(this).append($(supp));
          },
          function () {
            $(this).find("a:last").remove();
          }
        );

        $('.supp').click(function(e) {
            alert('supprimer');
            e.preventDefault();
        });

		$('.folderContent').hide();
		$('.folderTitle').click(function(e) {
			$(this).next().slideToggle();
		});

        //get rss complete feeds from all subscriptions
        $("#mainContent").text("Loading...");
        content = '<?xml version="1.0" encoding="utf-8"?>\n<rss version="2.0">\n';
        nbActiveRequest = 0;
        links = output.getElementsByTagName('a');
        //alert(links.length);
        $(links).each(function () {
            loadFeedContent($(this).attr('href'));
        });
        
    }

    function loadFeedContent(url) {
        nbActiveRequest++;
        $.get('http://w4.uqo.ca/monm30/echoXML.php?url=' + encodeURIComponent(url), function (cont) {
                $("#loading").text("Loading..." + nbActiveRequest);
                        nbActiveRequest--;

                try {
                    rssFeed = $.parseXML(cont);
                }
                catch (e) {
                    console.log(e);
                }

                channel = rssFeed.getElementsByTagName("channel")[0];
                content += xmlToString(channel);

                if (nbActiveRequest == 0) {
                    $("#mainContent").text("done");
                    content += '\n</rss>'
                    rss = $.parseXML(content);
                    rssXSL = loadXMLFile("feed.xsl");
                    rssResult = transform(rss, rssXSL);
                
                    if(navigator.userAgent.indexOf("Firefox") > -1) {
                        $("#mainContent").html(rssResult);
                        $(".article").each(function() {
                            var contentDiv = this.firstChild.nextSibling;
                            contentDiv.innerHTML = contentDiv.textContent;
                        });
                    }
                    else {
                        $("#mainContent").html(rssResult);
                    }
                }
        });
    }

    function loadOneFeedContent(url) {
        $("#mainContent").text("Loading...");
        var content = '<?xml version="1.0" encoding="utf-8"?>\n<rss version="2.0">\n';
        $.get('http://w4.uqo.ca/monm30/echoXML.php?url=' + encodeURIComponent(url), function (cont) {
                
                try {
                    rssFeed = $.parseXML(cont);
                }
                catch (e) {
                    console.log(e);
                }

                channel = rssFeed.getElementsByTagName("channel")[0];
                content += xmlToString(channel);

                $("#mainContent").text("done");
                content += '\n</rss>'
                rss = $.parseXML(content);
                rssXSL = loadXMLFile("feed.xsl");
                rssResult = transform(rss, rssXSL);
                
                if(navigator.userAgent.indexOf("Firefox") > -1) {
                    $("#mainContent").html(rssResult);
                    $(".article").each(function() {
                        var contentDiv = this.firstChild.nextSibling;
                        contentDiv.innerHTML = contentDiv.textContent;
                    });
                }
                else {
                    $("#mainContent").html(rssResult);
                    
                }
        });
    }

    function getCookie(c_name) {
        var c_value = document.cookie;
        var c_start = c_value.indexOf(" " + c_name + "=");
        if (c_start == -1) {
            c_start = c_value.indexOf(c_name + "=");
        }
        if (c_start == -1) {
            c_value = null;
        }
        else {
            c_start = c_value.indexOf("=", c_start) + 1;
            var c_end = c_value.indexOf(";", c_start);
            if (c_end == -1) {
                c_end = c_value.length;
            }
            c_value = unescape(c_value.substring(c_start, c_end));
        }
        return c_value;
    }

    function setCookie(c_name, value, exdays) {
        var exdate = new Date();
        exdate.setDate(exdate.getDate() + exdays);
        var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
        document.cookie = c_name + "=" + c_value;
    }

    </script>
</body>
</html>
