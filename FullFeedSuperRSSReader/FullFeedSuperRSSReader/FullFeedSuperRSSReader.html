<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link href="feed.css" rel="stylesheet" type="text/css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            border: 0;
        }
        #output, #loading {
            position: absolute;
        }
        #output {
            top: 0px;
            width: 500px;
            bottom: 0px;
        }
        #loading {
            top: 0px;
            left: 500px;
            right: 0;
            bottom: 0px;
        }

    </style>
</head>
<body>

<div id="output">Importez votre fichier d'abonnements<br />
<input id="fileinput" type="file" /><br /></div><div id="loading"></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<script type="text/javascript">

 function readSingleFile(evt) {
        //Retrieve the first (and only!) File from the FileList object
        var f = evt.target.files[0];

        if (f) {
            var r = new FileReader();
            r.onload = function (e) {
                var contents = e.target.result;

                //load le dom du fichier d'abonnements
                xmlDoc = $.parseXML(contents);

                //load le xslt
                xsl = loadXMLFile("abonnement.xsl");

                //transforme le fichier d'abonnements avec le xslt
                result = transform(xmlDoc, xsl);


                output = document.getElementById("output");
                output.appendChild(result);
                links = output.getElementsByTagName('a');

                //rss = loadXMLFile(links[0].href);
                //alert(rss); 

                //get rss complete feeds from all subscriptions
                var nbActiveRequest = 0;
                var content = '<?xml version="1.0" encoding="utf-8"?>\n<rss version="2.0">\n';
                $("#loading").text("Loading...");
                $(links).each(function () {
                    nbActiveRequest++;
                    $.get('http://w4.uqo.ca/monm30/echoXML.php?url=' + encodeURIComponent($(this).attr('href')), function (cont) {
                        $("#loading").text("Loading..." + nbActiveRequest);
                        nbActiveRequest--;
                        try {
				            rssFeed = $.parseXML(cont);
			            }
			            catch (e) {
				            console.log(e);
			            }
                        channel = rssFeed.getElementsByTagName("channel")[0];
                        //DEVRAIT LIMITER AUX ARTICLES RÉCENTS : UNE OU DEUX SEMAINE
                        //limite = loadXMLFile("limite.xsl");
                        //channel = transform(channel, limite);

                        //alert(xmlToString(channel));
                        content += xmlToString(channel);
                        if (nbActiveRequest == 0) {
                            $("#loading").text("done");
                            content += '\n</rss>'
                            alert(content);
                            rss = $.parseXML(content);
                            rssXSL = loadXMLFile("feed.xsl");
                            rssResult = transform(rss, rssXSL);
                            $("#loading").html(rssResult);
                        }
                    });
                });

                //                var string = (new XMLSerializer()).serializeToString(result);
                //                
                //                var blob = new Blob(["<?xml version='1.0' encoding='UTF-8'?>\n"+string], {
                //                    type: "text/plain;charset=utf-8;",
                //                });
                //                saveAs(blob, "subscriptions.xml");
            }
            r.readAsText(f);
        } else {
            alert("Failed to load file");
        }

    }
    document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

    //retourne une string à partir dUn dom xml
    function xmlToString(xmlData) {

        var xmlString;
        //IE
        if (window.ActiveXObject) {
            xmlString = xmlData.xml;
        }
        // code for Mozilla, Firefox, Opera, etc.
        else {
            xmlString = (new XMLSerializer()).serializeToString(xmlData);
        }
        return xmlString;
    } 

    //retourne le dom d'un fichier xml
    function loadXMLFile(file) {
        if (window.ActiveXObject) {
            xhttp = new ActiveXObject("Msxml2.XMLHTTP.3.0");
        }
        else {
            xhttp = new XMLHttpRequest();
        }
        xhttp.open("GET", file, false);
        xhttp.send("");
        return xhttp.responseXML;
    }

    //retourne le résultat de la transformation xsl
    function transform(xml, xsl) {
        if (window.ActiveXObject) {
            ex = xml.transformNode(xsl);
            document.getElementById("output").innerHTML = ex;
        }
        // code for Mozilla, Firefox, Opera, etc.
        else if (document.implementation && document.implementation.createDocument) {
            xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xsl);
            resultDocument = xsltProcessor.transformToFragment(xml, document);
            return resultDocument;
        }
    }

//    //load le dom du fichier d'abonnements
//    xmlDoc = loadXMLFile("subscriptions.xml");

//    //load le xslt
//    xsl = loadXMLFile("abonnement.xsl");

//    //transforme le fichier d'abonnements avec le xslt
//    result = transform(xmlDoc, xsl);
//    //alert(result);

    </script>
</body>
</html>
